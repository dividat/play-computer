- name: Logout Lab user
  become: true
  shell: skill -KILL -u lab && sleep 10
  when: clean_all_lab_data

- name: Cleanup
  become: true
  user:
    name: lab
    state: absent
    remove: yes
  when: clean_all_lab_data

- name: Add nopasswdlogin group
  become: true
  group:
    name: nopasswdlogin
    state: present

- name: Add lab user
  become: true
  user:
    name: lab
    comment: "Dividat Lab"
    password: $6$Ev6hoX3w$RaWbeHNXmnir0l5yMfgGuItQ3WkQoR0LZnhVg6m4vJ461vrPpZG.ZORmmIr5BF6Qm6gVE8ADa8fOx3eBRMjUE1
    groups: nopasswdlogin

- name: Install Chromium
  become: true
  apt:
    name: chromium-browser

- name: Ensure ~/bin directory exists
  become: true
  file:
    path: /home/lab/bin/
    owner: lab
    group: lab
    state: directory

- name: Add lab-kiosk script
  become: true
  template:
    src: templates/lab-kiosk.sh.j2
    dest: /home/lab/bin/lab-kiosk.sh
    owner: lab
    group: lab
    mode: u+x

- name: Ensure ~/.local/share/keyrings directory exists
  become: true
  file:
    path: /home/lab/.local/share/keyrings
    owner: lab
    group: lab
    state: directory

- name: Add default keyring to prevent gnome dialog (1/2)
  become: true
  template:
    src: templates/keyrings/Default_keyring.keyring
    dest: /home/lab/.local/share/keyrings/Default_keyring.keyring
    owner: lab
    group: lab

- name: Add default keyring to prevent gnome dialog (2/2)
  become: true
  template:
    src: templates/keyrings/default
    dest: /home/lab/.local/share/keyrings/default
    owner: lab
    group: lab

- name: Simulate Chromium first run (1/2)
  become: true
  file:
    path: /home/lab/.config/chromium
    owner: lab
    group: lab
    state: directory

- name: Simulate Chromium first run (2/2)
  become: true
  file:
    path: "/home/lab/.config/chromium/First Run"
    owner: lab
    group: lab
    state: touch

- name: Ensure ~/.config/autostart directory exists
  become: true
  file:
    path: /home/lab/.config/autostart
    owner: lab
    group: lab
    state: directory

- name: Autostart lab-kiosk
  become: true
  template:
    src: templates/lab-kiosk.desktop
    dest: /home/lab/.config/autostart/lab-kiosk.desktop
    owner: lab
    group: lab

- name: Ensure /etc/lightdm/lightdm.conf.d directory exists
  become: true
  file:
    path: /etc/lightdm/lightdm.conf.d
    state: directory

- name: Enable auto login in lightdm
  become: true
  template:
    src: templates/50-lab-autologin.conf
    dest: /etc/lightdm/lightdm.conf.d/50-lab-autologin.conf

- name: Enable auto login in gdm
  become: true
  template:
    src: templates/custom.conf
    dest: /etc/gdm3/custom.conf
  ignore_errors: true

- name: Add PAM rule to allow passwordless login in GDM
  become: true
  lineinfile:
    insertbefore: BOF
    path: /etc/pam.d/gdm-password
    line: auth sufficient pam_succeed_if.so user ingroup nopasswdlogin
    state: present
  ignore_errors: true

- name: Disable apport
  become: true
  systemd:
    name: apport
    state: stopped
    enabled: no
    masked: yes
  # This may fail during setup as state is unknown
  ignore_errors: true
